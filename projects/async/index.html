<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app">
    <div id="loading-block">Загрузка...</div>
    <div id="loading-failed">
      <div>Не удалось загрузить города</div>
      <button id="retry-button">Повторить</button>
    </div>
    <div id="filter-block">
      <input id="filter-input" placeholder="название города" type="text">

      <div id="filter-result"></div>
    </div>
  </div>
  <script>
    const homeworkContainer = document.querySelector('#app');
    /* Блок с надписью "Загрузка" */
    const loadingBlock = homeworkContainer.querySelector('#loading-block');
    /* Блок с надписью "Не удалось загрузить города" и кнопкой "Повторить" */
    const loadingFailedBlock = homeworkContainer.querySelector('#loading-failed');
    /* Кнопка "Повторить" */
    const retryButton = homeworkContainer.querySelector('#retry-button');
    /* Блок с текстовым полем и результатом поиска */
    const filterBlock = homeworkContainer.querySelector('#filter-block');
    /* Текстовое поле для поиска по городам */
    const filterInput = homeworkContainer.querySelector('#filter-input');
    /* Блок с результатами поиска */
    const filterResult = homeworkContainer.querySelector('#filter-result');


    filterBlock.classList.add('hidden');
    loadingFailedBlock.classList.add('hidden');
    const hiddenBlock = document.querySelectorAll('.hidden');
    for (const hiddenBlock of hiddenBlock) {
      // hiddenBlock.style.display = "none";
    }

    

    function loadAndSortTowns() {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://raw.githubusercontent.com/smelukov/citiesTest/master/cities.json');
        xhr.responseType = 'json';
        xhr.send();
        xhr.addEventListener('load', () => {
          if ((xhr.status < 400) && (xhr.status !== 0)) {
            // setTimeout(() => {
            let sortTowns = xhr.response;
            sortTowns.sort(function (a, b) {
              if (a.name > b.name) {
                return 1;
              }
              if (a.name < b.name) {
                return -1;
              }
              return 0;
            });
            // }, 1000);
            resolve(sortTowns);
          } else {
            reject()
          };
        });
      });
    }

let townArray = [];

    function loadTowns() {
      let callPromise = loadAndSortTowns().then((response) => {return townArray = response });
      return callPromise;
    }
    
    
    let towns = loadTowns();
    console.log(townArray);
    

    function isMatching(full, chunk) {
      let townsToLowerCase = full.toLowerCase();
      let chunkToLowerCase = chunk.toLowerCase();
      let substrIsTrue = townsToLowerCase.includes(chunkToLowerCase);
      return substrIsTrue
    }

    retryButton.addEventListener('click', () => { 
      try {

      } catch (error) {

      }
    });

    filterInput.addEventListener('input', function (event) { 
      filterResult.innerHTML = '';
      const fragment = document.createDocumentFragment();
      const inputText = this.value;
      // const inputText = filterInput.value;

      townsArray.then(function (towns) {
        return 
        for (let i=0; i< towns.length; i++) {
          if((inputText || inputText === 0 || inputText === '0') && isMatching(towns[i].name, inputText)) {
            const newDiv = document.createElement('div');
            newDiv.textContent = town.name;
            filterResult.appendChild(newDiv);
          }
        }
      });
    });

  </script>
</body>

</html>