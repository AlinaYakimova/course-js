<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="app">
    <div id="loading-block">Загрузка...</div>
    <div id="loading-failed">
      <div>Не удалось загрузить города</div>
      <button id="retry-button">Повторить</button>
    </div>
    <div id="filter-block">
      <input id="filter-input" placeholder="название города" type="text">

      <div id="filter-result"></div>
    </div>
  </div>
  <script>

    function loadAndSortTowns() {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://raw.githubusercontent.com/smelukov/citiesTest/master/cities.json');
        xhr.responseType = 'json';
        xhr.send();
        xhr.addEventListener('load', () => {
          if ((xhr.status < 400) && (xhr.status !== 0)) {
            // setTimeout(() => {
            let sortTowns = xhr.response;
            sortTowns.sort(function (a, b) {
              if (a.name > b.name) {
                return 1;
              }
              if (a.name < b.name) {
                return -1;
              }
              return 0;
            });
            // }, 1000);
            resolve(sortTowns);
          } else {
            reject()
          };
        });
      });
    }

    function loadTowns() {
      return loadAndSortTowns();
    }

    function isMatching(full, chunk) {
      let townsToLowerCase = full.toLowerCase();
      let chunkToLowerCase = chunk.toLowerCase();
      let substrIsTrue = townsToLowerCase.includes(chunkToLowerCase);
      return substrIsTrue;
    }

    const homeworkContainer = document.querySelector('#app');
    /* Блок с надписью "Загрузка" */
    const loadingBlock = homeworkContainer.querySelector('#loading-block');
    /* Блок с надписью "Не удалось загрузить города" и кнопкой "Повторить" */
    const loadingFailedBlock = homeworkContainer.querySelector('#loading-failed');
    /* Кнопка "Повторить" */
    const retryButton = homeworkContainer.querySelector('#retry-button');
    /* Блок с текстовым полем и результатом поиска */
    const filterBlock = homeworkContainer.querySelector('#filter-block');
    /* Текстовое поле для поиска по городам */
    const filterInput = homeworkContainer.querySelector('#filter-input');
    /* Блок с результатами поиска */
    const filterResult = homeworkContainer.querySelector('#filter-result');

    retryButton.addEventListener('click', () => {
      tryToLoad();
    });

    filterInput.addEventListener('input', function (event) {
      filterResult.innerHTML = '';
      const fragment = document.createDocumentFragment();

      const inputText = this.value;
      // const inputText = filterInput.value;

      loadTowns().then(function (towns) {

        for (const town of towns) {
          if ((inputText || inputText === 0 || inputText === '0') && isMatching(town.name, inputText)) {
            const townDiv = document.createElement('div');
            townDiv.textContent = town.name;
            fragment.append(townDiv);
          }
        }
        filterResult.append(fragment);
      });
    });

    loadingFailedBlock.style.display = "none";
    filterBlock.style.display = "none";

    let townsArray = [];

    async function tryToLoad() {
      try {
        townsArray = await loadTowns();
        loadingBlock.style = "display: none";
        loadingFailedBlock.style = "display: none";
        filterBlock.style = "null";

      } catch (error) {
        loadingBlock.style = "display: none";
        loadingFailedBlock.style = "null";
      }
    }

    tryToLoad();

  </script>
</body>

</html>